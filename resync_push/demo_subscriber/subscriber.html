<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Subscriber - ResourceSync</title>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
        <script src="http://www.eslinstructor.net/vkbeautify/vkbeautify.js"></script>
        <style>
            #toolbar {
                padding: 4px;
                display: inline-block;
                width: 100%;
            }
            /* support: IE7 */
            *+html #toolbar {
                display: inline;
            }
            .adjacent {
                width: 50%;
                height: 50%;
                float: left;
                min-height: 300px;
                overflow-wrap: break-word;
            }
            .full {
                width: 100%;
                height: 50%;
                min-height: 300px;
            }
            td, th {
                border-bottom: 1px solid #ccc;
            }
            ui-dialog, ui-widget {
                width: auto;
            }

        </style>
        <script>
            WS_HUB_URL = "ws://localhost:8081";

            demo_topic_urls = {
                "hub": "http://localhost:8080/demo_hub",
                "subscriber": "http://localhost:9500/demo_subscriber",
                "publisher": "http://localhost:8000/demo_publisher"
            }

            jQuery.fn.center = function () {
                this.css("position","absolute");
                this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) + 
                                                            $(window).scrollLeft()) + "px");
                return this;
            }


            $( function() {
                initWS();
            });

            function subscribe() {
                for (source in demo_topic_urls) {
                    topic = demo_topic_urls[source];
                    var data = {};
                    data['hub.topic'] = topic;
                    data['hub.mode'] = "subscribe";
                    sendToServer(data);
                    //subscribe( topic );
                }
            }

            var wsConn;

            // initializing websocket connection
            function initWS() {
                wsConn = new WebSocket(WS_HUB_URL);

                wsConn.onmessage = handleMessage;
                wsConn.onopen = subscribe;
                wsConn.onerror = wsError;
            }

            function wsError(data) {
                console.log(data)
            }

            function sendToServer(data) {
                if (wsConn.readyState != 1) {
                    initWS();
                    setTimeout(wsConn.send(JSON.stringify(data)), 1000);
                }
                else {
                    wsConn.send(JSON.stringify(data));
                }
            }

            function showDialog(container) {
                $("#"+container).dialog("open");
            }

            dialogCount = 0
            function handleMessage(event) {
                data = null;
                notification = false;

                try {
                    data = $.parseJSON(event['data']);
                } 
                catch(e) {
                    handleXML(event['data']);
                    return;
                }
                if (!data) {
                    return;
                }
                
                if (data['hub.challenge']) {
                    handleSubscriptions(data);
                    return
                }
                else {
                    handleNotifications(data);
                    return
                }
            }

            function handleXML(xmldata) {
                data = {}
                x = $.parseXML(xmldata.trim());
                x = $(x);
                data['resource'] = x.find('loc').text();
                data['msg'] = [];
                if (x.find('md').attr('change') == "deleted") {
                    data['msg'].push('Resource deleted.');
                }
                else if (x.find('md').attr('change') == "created") {
                    data['msg'].push('Resource created.');
                }
                else if (x.find('md').attr('change') == "updated") {
                    data['msg'].push('Resource updated.');
                }
                data['msg'].push('Payload: '+x.find('md').attr('length')+" bytes");
                hash = x.find('md').attr('hash');
                if (hash) {
                    data['msg'].push('MD5 hash: ' + hash);
                }
                data['payload'] = xmldata;
                data['demo_link_header'] = 'demo_publisher';

                handleNotifications(data)

            }



            dialog_title = {}
            function handleNotifications(data) {
                text = ""
                text += "<b>" + data['resource'] + "</b><br/>";

                for (var i=0, m; m=data['msg'][i]; i++) {
                    text += m + "<br/>"; 
                }
                text += "<div id='dialog_"+dialogCount+"'><pre>"+ htmlEntities(vkbeautify.xml(data['payload'])) + "</pre></div>";
                dialog_title[dialogCount] = "Payload for " + data['resource']
                text += "<a href='#' onclick='return showDialog(\"dialog_"+dialogCount+"\")'>Payload</a>";
                dialogCount++;

                if (data['link_header']) {
                    text += "<br/>";
                    text += "<div id='dialog_"+dialogCount+"'><pre>"+ htmlEntities(data['link_header']) + "</pre></div>";
                    dialog_title[dialogCount] = "Link Header value for " + data['resource']
                    text += "<a href='#' onclick='return showDialog(\"dialog_"+dialogCount+"\")'>Link Header</a>";
                    dialogCount++;
                }

                var container = "";
                for (source in demo_topic_urls) {
                    if (data['demo_link_header'].search(demo_topic_urls[source]) >= 0) {
                        var url_comp = demo_topic_urls[source].split("/");
                        container = url_comp[url_comp.length - 1];
                    }
                }
                
                $("#" + container).append(text);

                c = $("#" + container)
                c.removeAttr("id")
                cindex = 0
                if (container.search("hub") >= 0) {
                    cindex = 1
                }
                else if (container.search("subscriber") >= 0) {
                    cindex = 2
                }

                if (c.parent().next() && c.parent().next().prop('tagName') == "TR") {
                    $(c.parent().next().children()[cindex]).attr("id", container)
                }
                else {
                    c.parent().parent().append("<tr><td></td><td></td><td></td></tr>")
                    $(c.parent().next().children()[cindex]).attr("id", container)
                }

                for( i=0; i<dialogCount; i++) {
                    $( "#dialog_"+i).dialog({
                        title: dialog_title[i],
                        autoOpen: false,
                        width: 750,
                        resizable: false,
                        position: {
                            my: 'center',
                            at: 'center',
                            of: window
                        }
                    });
                }
            }

            function htmlEntities(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }
            function handleSubscriptions(data) {
                if (data['hub.challenge']) {
                    sendToServer(data)
                }
            }


        </script>
    </head>
    <body>
        <table style="width: 100%; height: 100%;">
            <tr style="height: 25px;">
                <th>Source</th>
                <th>Hub</th>
                <th>Destination</th>
            </tr>
            <tr>
                <td id="demo_publisher" style="width: 33%"></td>
                <td id="demo_hub" style="width: 33%"></td>
                <td id="demo_subscriber" style="width: 33%"></td>
            </tr>
        </table>
    </body>
</html>
